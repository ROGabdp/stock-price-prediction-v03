# Feature Specification: 股價漲跌機率預測系統

**Feature Branch**: `001-stock-price-prediction`
**Created**: 2025-11-13
**Status**: Draft
**Input**: User description: "開發一個股價漲跌機率預測系統，運用機器學習模型 (建構 LSTM 神經網路模型，執行自動超參數調整，自動完成訓練並評估模型。) 從歷史資料中學習，並預測未來 N 天 (預測天數 N 可配置 ，可選擇 1 到 30 天) 的股價漲跌機率與幅度。系統將提供使用者介面，支援模型訓練、已訓練模型的選擇、訓練資料的選擇與更新，並以圖表形式視覺化歷史數據與預測結果。歷史資料不用從網路下載，使用者會自行準備歷史資料的 csv 檔案。範例檔案如跟目錄下的 19940513-20251111-converted.csv。請先參考裡面的格式和內容，來了解模型的變數。使用者要能夠選擇他要預測股價的起始日期以及預測的天數。UI 上要利用使用者提供的歷史資料，將資料中的股價以及模型預測的股價畫出來。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 訓練股價預測模型 (Priority: P1)

使用者想要使用已匯入的歷史股價資料訓練一個新的預測模型。使用者選擇一個資料檔案、設定預測天數（1-30 天）、為模型命名，系統自動載入資料、建構 LSTM 神經網路、執行超參數調整，並完成模型訓練與評估。訓練完成後，使用者可以看到模型的評估指標（如準確率、損失值等），系統自動儲存模型以供後續使用。

**Why this priority**: 這是系統的核心功能，沒有訓練好的模型就無法進行預測。這是建立整個預測系統的基礎。

**Independent Test**: 可透過選擇一個已匯入的資料檔案（如「19940513-20251111-converted.csv」）、設定預測天數為 5 天、輸入模型名稱，執行訓練流程，驗證系統能否成功訓練模型並顯示評估結果。此功能獨立交付價值：產生一個可用的預測模型。

**Acceptance Scenarios**:

1. **Given** 使用者位於模型訓練頁面且系統中有已匯入的資料檔案，**When** 使用者選擇資料檔案「19940513-20251111-converted.csv」、輸入模型名稱「台股預測模型 v1」、設定預測天數為 5 天並點擊「開始訓練」，**Then** 系統開始載入資料並顯示訓練進度
2. **Given** 模型訓練正在進行中，**When** 訓練完成，**Then** 系統顯示模型評估指標（訓練準確率、驗證準確率、損失值等）並自動儲存模型
3. **Given** 模型訓練完成且評估指標已顯示，**When** 使用者返回模型清單頁面，**Then** 系統顯示新訓練的模型及其詳細資訊
4. **Given** 使用者未選擇資料檔案或未輸入模型名稱，**When** 使用者點擊「開始訓練」，**Then** 系統顯示驗證錯誤訊息「請選擇資料檔案並輸入模型名稱」

---

### User Story 2 - 使用已訓練模型進行股價預測 (Priority: P1)

使用者選擇一個已訓練好的模型，選擇一個資料檔案，並指定預測的起始日期。系統根據起始日期之前的歷史資料作為輸入，預測從起始日期開始的未來 N 天（模型設定的預測天數）的股價漲跌機率與幅度。預測結果以圖表形式呈現，同時顯示完整的歷史股價走勢與模型預測的股價走勢，使用者可以直觀比較歷史資料與預測結果。

**Why this priority**: 預測功能是系統的最終目標與核心價值，使用者訓練模型的目的就是為了獲得準確的預測結果。此功能與模型訓練同等重要。

**Independent Test**: 可透過選擇一個已訓練的模型、選擇一個資料檔案、指定預測起始日期（如 2025-10-01），驗證系統能否顯示從該日期開始未來 N 天的預測結果與視覺化圖表。此功能獨立交付價值：提供使用者預測資訊以輔助投資決策。

**Acceptance Scenarios**:

1. **Given** 使用者位於預測頁面且系統中有已訓練的模型與資料檔案，**When** 使用者從下拉選單中選擇一個模型並選擇資料檔案「19940513-20251111-converted.csv」，**Then** 系統顯示模型資訊（訓練時間、使用的資料檔案、預測天數、評估指標）並提供日期選擇器
2. **Given** 使用者已選擇模型與資料檔案，**When** 使用者透過日期選擇器指定預測起始日期為「2025-10-01」並點擊「開始預測」，**Then** 系統使用起始日期之前的歷史資料執行預測，顯示從 2025-10-01 開始未來 N 天的漲跌機率與預測股價
3. **Given** 預測已完成，**When** 使用者查看預測結果，**Then** 系統顯示完整的互動式圖表，包含歷史股價走勢（從資料檔案起始日期至預測起始日期）與模型預測的股價走勢（從預測起始日期至未來 N 天），圖表中清楚標示漲跌機率、預測幅度與預測區間
4. **Given** 使用者選擇的預測起始日期超出資料檔案的時間範圍，**When** 使用者點擊「開始預測」，**Then** 系統顯示錯誤訊息「預測起始日期必須在資料檔案的時間範圍內」
5. **Given** 使用者選擇的資料檔案與模型訓練時使用的不同，**When** 使用者點擊「開始預測」，**Then** 系統顯示警告訊息「此模型訓練於不同資料檔案，預測結果可能不準確」

---

### User Story 3 - 管理與匯入歷史股價資料 (Priority: P2)

使用者可以查看系統中已匯入的歷史股價資料，包含資料檔案名稱、資料時間範圍、匯入時間等資訊。使用者可以透過上傳 CSV 檔案新增或更新股價資料。CSV 檔案需包含標準欄位（date, open, high, low, close, volume）以及技術指標欄位（SMA, MA, MACD, KD 等），系統會驗證檔案格式並載入資料。

**Why this priority**: 資料是模型訓練與預測的基礎，但資料管理可以在模型訓練功能完成後再實作。初期可使用預先準備的歷史資料，此功能提升系統的可維護性與資料管理彈性。

**Independent Test**: 可透過查看資料清單、上傳一個符合格式的 CSV 檔案，驗證系統能否成功載入並顯示資料。此功能獨立交付價值：允許使用者管理自己的歷史資料。

**Acceptance Scenarios**:

1. **Given** 使用者位於資料管理頁面，**When** 使用者查看資料清單，**Then** 系統顯示所有已匯入的資料檔案，包含檔案名稱、資料時間範圍（起始日期至結束日期）、匯入時間、資料筆數
2. **Given** 使用者點擊「匯入資料」按鈕，**When** 使用者選擇一個 CSV 檔案並上傳，**Then** 系統驗證檔案格式、解析資料並顯示匯入進度
3. **Given** 資料匯入完成，**When** 使用者返回資料清單，**Then** 系統顯示新匯入的資料檔案與相關資訊
4. **Given** 使用者上傳的 CSV 檔案格式不正確（缺少必要欄位或日期格式錯誤），**When** 系統驗證檔案，**Then** 系統顯示錯誤訊息「CSV 檔案格式不正確，請確認包含必要欄位：date, open, high, low, close, volume」

---

### User Story 4 - 比較多個模型的預測結果 (Priority: P3)

使用者可以同時選擇多個已訓練的模型，針對同一個資料檔案與相同的預測起始日期執行預測，系統以圖表形式並排顯示不同模型的預測結果。每個模型的圖表都包含完整的歷史股價走勢與預測股價走勢，使用者可以直觀比較不同模型的預測差異，選擇最符合預期的模型。

**Why this priority**: 這是進階功能，提升使用者體驗與決策品質。在核心預測功能完成後，此功能可以幫助使用者評估不同模型的表現。

**Independent Test**: 可透過選擇 2-3 個模型、選擇相同資料檔案與預測起始日期，驗證系統能否並排顯示不同模型的預測結果圖表。此功能獨立交付價值：提供更全面的預測視角。

**Acceptance Scenarios**:

1. **Given** 使用者位於比較頁面且系統中有多個已訓練的模型，**When** 使用者選擇 3 個模型並選擇資料檔案「19940513-20251111-converted.csv」、指定預測起始日期「2025-10-01」，**Then** 系統顯示所選模型的基本資訊
2. **Given** 使用者已選擇多個模型、資料檔案與預測起始日期，**When** 使用者點擊「開始比較」，**Then** 系統執行預測並以並排方式顯示 3 個模型的預測圖表，每個圖表包含歷史股價與預測股價
3. **Given** 比較圖表已顯示，**When** 使用者將滑鼠懸停在圖表上，**Then** 系統顯示該時間點各模型預測的詳細數值（漲跌機率、預測幅度、預測股價）
4. **Given** 使用者選擇的模型中有部分模型預測天數不同，**When** 預測完成，**Then** 系統在圖表中清楚標示各模型的預測範圍，較長的預測天數會顯示更長的預測走勢

---

### Edge Cases

- **資料不足時的處理：** 當選擇的歷史資料不足以訓練模型時（例如資料筆數少於 60 筆），系統應顯示錯誤訊息「歷史資料不足，至少需要 60 筆資料才能訓練模型」
- **CSV 檔案格式錯誤：** 當使用者上傳的 CSV 檔案缺少必要欄位、日期格式不正確或包含無效數值時，系統應顯示詳細的錯誤訊息指出問題所在，並提供範例檔案格式說明
- **CSV 檔案過大：** 當上傳的 CSV 檔案超過系統限制（例如超過 100MB 或 100 萬筆資料）時，系統應顯示警告訊息「檔案過大，請分割檔案後再上傳」
- **模型訓練失敗：** 當模型訓練過程中發生錯誤（例如資料格式錯誤、記憶體不足），系統應顯示錯誤訊息並記錄錯誤日誌，使用者可以查看錯誤詳情
- **預測結果為空：** 當模型無法產生有效預測時（例如輸入資料異常），系統應顯示警告訊息「無法產生預測結果，請檢查輸入資料或重新訓練模型」
- **同時執行多個訓練任務：** 當使用者嘗試同時啟動多個模型訓練任務時，系統應顯示提示訊息「已有訓練任務正在進行中，請等待完成後再開始新的訓練」或允許使用者將任務加入佇列
- **儲存空間不足：** 當系統儲存空間不足以儲存新的歷史資料或模型時，系統應顯示警告訊息「儲存空間不足，請清理舊資料或擴充儲存空間」
- **預測天數超出範圍：** 當使用者設定的預測天數不在 1-30 天範圍內時，系統應顯示驗證錯誤「預測天數必須在 1 到 30 天之間」
- **預測起始日期無效：** 當使用者選擇的預測起始日期超出資料檔案的時間範圍時，系統應顯示錯誤訊息「預測起始日期必須在資料檔案的時間範圍內（YYYY-MM-DD 至 YYYY-MM-DD）」
- **預測起始日期之前資料不足：** 當預測起始日期之前的歷史資料筆數不足時（例如少於模型所需的最小輸入長度），系統應顯示錯誤訊息「預測起始日期之前的歷史資料不足，請選擇較晚的日期」

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須允許使用者建立新的模型訓練任務，使用者可選擇已匯入的資料檔案、設定預測天數（1-30 天範圍）、為模型命名
- **FR-002**: 系統必須載入選定的歷史資料檔案，並驗證資料的完整性與有效性（檢查必要欄位是否存在、數值是否有效）
- **FR-003**: 系統必須使用 LSTM 神經網路架構建構預測模型
- **FR-004**: 系統必須自動執行超參數調整，以找到最佳的模型配置
- **FR-005**: 系統必須在模型訓練過程中顯示即時進度（如當前訓練週期、損失值）
- **FR-006**: 系統必須在訓練完成後顯示模型評估指標，包含訓練準確率、驗證準確率、損失值等
- **FR-007**: 系統必須自動儲存訓練好的模型，並記錄模型元資料（名稱、訓練時間、使用的資料檔案、預測天數、評估指標）
- **FR-008**: 系統必須提供已訓練模型清單，使用者可選擇模型查看詳細資訊（訓練時間、使用的資料檔案名稱、預測天數、評估指標）
- **FR-009**: 系統必須允許使用者選擇已訓練的模型、選擇資料檔案，並透過日期選擇器指定預測的起始日期
- **FR-010**: 系統必須驗證預測起始日期是否在資料檔案的時間範圍內，若無效則顯示錯誤訊息
- **FR-011**: 系統必須驗證預測起始日期之前是否有足夠的歷史資料（至少需符合模型輸入長度要求），若不足則顯示錯誤訊息
- **FR-012**: 系統必須根據預測起始日期之前的歷史資料作為模型輸入，執行預測並顯示從起始日期開始未來 N 天的漲跌機率、預測幅度與預測股價
- **FR-013**: 系統必須以圖表形式同時視覺化歷史股價資料與預測股價資料，圖表需包含時間軸、歷史股價走勢（從資料起始日期至預測起始日期）、預測股價走勢（從預測起始日期至未來 N 天）
- **FR-014**: 系統必須在圖表中清楚區分歷史股價與預測股價（例如使用不同顏色或線條樣式），並標示預測起始日期的分界點
- **FR-015**: 系統必須提供互動式圖表，使用者可以縮放、平移、查看特定時間點的詳細數值（日期、開盤價、收盤價、漲跌機率、預測幅度）
- **FR-016**: 系統必須允許使用者查看已匯入的歷史股價資料清單，顯示檔案名稱、資料時間範圍、匯入時間、資料筆數
- **FR-017**: 系統必須允許使用者上傳 CSV 格式的歷史股價資料檔案
- **FR-018**: 系統必須驗證上傳的 CSV 檔案格式，檢查必要欄位（date, open, high, low, close, volume）是否存在
- **FR-019**: 系統必須解析 CSV 檔案中的日期格式（支援 YYYY/M/D 與 YYYY-MM-DD 格式），若格式無效則顯示錯誤訊息
- **FR-020**: 系統必須在資料不足時（少於 60 筆）拒絕訓練並顯示錯誤訊息
- **FR-021**: 系統必須在 CSV 檔案包含無效數值時（例如價格為負數或非數字）顯示錯誤訊息並指出問題欄位
- **FR-022**: 系統必須記錄所有模型訓練與預測的操作日誌，包含時間戳記、使用者操作、結果狀態
- **FR-023**: 系統必須允許使用者刪除已儲存的模型與歷史資料
- **FR-024**: 系統必須支援多個模型的同時比較功能，在比較頁面允許使用者選擇相同的預測起始日期，以圖表並排顯示預測結果（每個圖表包含歷史與預測股價）
- **FR-025**: 系統必須在模型訓練失敗時記錄錯誤日誌並顯示錯誤詳情給使用者
- **FR-026**: 系統必須持久化儲存訓練好的模型與歷史資料，系統重啟後資料不遺失
- **FR-027**: 系統必須提供使用者介面以執行所有上述功能，介面需使用正體中文

### Key Entities

- **資料檔案 (Data File)**: 使用者上傳的 CSV 檔案，包含歷史股價資料。屬性包含檔案名稱、匯入時間、資料時間範圍（起始日期至結束日期）、資料筆數、檔案路徑
- **歷史股價資料 (Historical Stock Data)**: CSV 檔案中的股價記錄，包含必要欄位（date, open, high, low, close, volume）與可選技術指標欄位（SMA5, SMA10, MA5, MA10, MACD, KD 等）。每筆資料代表一個交易日的股價資訊
- **預測模型 (Prediction Model)**: 訓練好的 LSTM 神經網路模型，包含模型名稱、訓練時間、訓練用的資料檔案名稱、預測天數、超參數配置、評估指標（訓練準確率、驗證準確率、損失值）等屬性
- **預測請求 (Prediction Request)**: 使用者發起的預測請求，包含選擇的模型、資料檔案、預測起始日期等資訊
- **預測結果 (Prediction Result)**: 模型針對特定資料檔案與預測起始日期產生的預測輸出，包含預測日期序列（從起始日期至未來 N 天）、每日的漲跌機率（0-1 之間的數值，代表收盤價上漲的機率）、預測幅度（百分比，代表預測的價格變化幅度）、預測股價（預測的收盤價數值）等欄位
- **訓練任務 (Training Task)**: 代表一次模型訓練的執行記錄，包含任務 ID、模型名稱、使用的資料檔案、預測天數、開始時間、結束時間、狀態（進行中、已完成、失敗）、進度資訊（當前週期、損失值）等
- **超參數配置 (Hyperparameter Configuration)**: 模型訓練時使用的參數設定，包含學習率、批次大小、訓練週期數、LSTM 層數、隱藏層神經元數量、dropout 比例等（由自動超參數調整產生）
- **CSV 欄位定義 (CSV Column Definition)**: 定義 CSV 檔案中各欄位的名稱、資料型態、是否必填。必要欄位包含 date（日期，YYYY/M/D 或 YYYY-MM-DD 格式）、open（開盤價）、high（最高價）、low（最低價）、close（收盤價）、volume（成交量）

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者能在 10 分鐘內完成一個股票的模型訓練流程（假設歷史資料已存在且資料量適中）
- **SC-002**: 系統能同時支援至少 3 個使用者執行模型訓練或預測任務，不出現明顯效能衰退
- **SC-003**: 模型訓練完成後，90% 的評估指標（準確率）達到 60% 以上（基於歷史回測）
- **SC-004**: 預測結果的圖表載入與顯示時間在 5 秒內完成
- **SC-005**: 使用者能在 3 次點擊內完成從選擇模型到查看預測結果的完整流程
- **SC-006**: CSV 檔案上傳與匯入功能能在 30 秒內完成（假設檔案包含 1 年約 250 筆的日股價資料）
- **SC-007**: 系統錯誤率低於 5%（以 100 次操作為基準，包含訓練、預測、資料更新）
- **SC-008**: 使用者介面的回應時間（點擊按鈕到畫面更新）在 1 秒內
- **SC-009**: 90% 的使用者能在首次使用時不需要查看說明文件就能完成模型訓練與預測流程
- **SC-010**: 系統能儲存至少 50 個訓練好的模型與 100 個資料檔案，不出現效能問題

## Assumptions _(optional)_

- 假設系統部署於單機環境（非分散式系統），初期不需考慮多伺服器架構
- 假設使用者會自行準備歷史股價資料的 CSV 檔案，檔案格式需符合系統定義的欄位結構
- 假設 CSV 檔案的範例格式如專案根目錄下的 `19940513-20251111-converted.csv`，包含基本股價欄位與技術指標欄位
- 假設使用者具備基本的股票投資知識，理解開盤價、收盤價、成交量等概念
- 假設系統使用者數量為小規模（10 人以內），初期不需考慮大規模並發需求
- 假設模型訓練至少需要 60 筆的歷史資料才能產生有效預測
- 假設預測的「漲跌機率」定義為：未來 N 天收盤價高於當前收盤價的機率
- 假設預測的「幅度」定義為：未來 N 天收盤價相對於當前收盤價的百分比變化
- 假設系統運行環境有足夠的運算資源（CPU/GPU）支援 LSTM 模型訓練
- 假設系統使用者介面為網頁應用程式，可在現代瀏覽器（Chrome、Firefox、Edge）上執行
- 假設 CSV 檔案大小不超過 100MB，資料筆數不超過 100 萬筆
- 假設使用者上傳的 CSV 檔案已包含必要的技術指標（SMA, MA, MACD, KD 等），系統不需自行計算這些指標

## Out of Scope _(optional)_

以下功能不在此版本的範圍內，但可在未來版本考慮：

- **多使用者帳號系統與權限管理**: 初期版本為單使用者或共享使用模式，不實作使用者註冊、登入、權限控制功能
- **即時股價監控與警報**: 不提供即時股價追蹤、價格警報、自動通知功能
- **投資組合管理**: 不提供使用者管理多支股票投資組合、追蹤損益、資產配置等功能
- **社群分享與討論**: 不提供使用者分享預測結果、討論區、評論功能
- **行動應用程式（Mobile App）**: 初期僅提供網頁介面，不開發 iOS/Android 原生應用程式
- **多種機器學習模型選擇**: 初期僅支援 LSTM 模型，不提供其他模型（如 GRU、Transformer、傳統統計模型）的選擇
- **模型自動重新訓練**: 不提供排程自動重新訓練模型的功能，使用者需手動觸發訓練
- **技術指標自動計算**: 系統不自動計算技術分析指標（如 SMA、MACD、KD 等），假設使用者上傳的 CSV 檔案已包含這些指標
- **網路資料下載功能**: 系統不提供從外部 API（如 Yahoo Finance）自動下載股價資料的功能，所有資料需由使用者自行準備並上傳
- **跨市場資料整合**: 不整合多國股市資料，使用者上傳的資料檔案可以是任何市場，但系統不提供市場識別或整合功能
- **API 對外開放**: 不提供 RESTful API 供第三方應用程式存取預測功能
- **CSV 檔案格式轉換**: 系統不提供將其他格式（如 Excel、JSON）轉換為 CSV 的功能，使用者需自行準備符合格式的 CSV 檔案
